# PL/pgSQL
- full postgresql internal
- control structure
- variable declaration
- expression
- loops
- cursors
- Complex function
- new data type
- stored procedure
- and more
### sql vs pl/sql
- sql
  - query language but can only execute statement individually
- pl/sql
  - wrap multiple statment in obj
  - store obj in server
  - provide transactional integrity

## Structure
- lable , declare are option
- begin , end are must
```
[<<lable>>]
[ declare
  variable declaration; ]
  begin
    statement
  end; [lable];

```

## PL function
- similat to sql function
```
-- to create   begin must , select --> return
create function fn_table_name(p1 type....) returns retrns_type as
$$
  begin
    return max(id) from vv;
  end;
$$
language plpgsql

-- calling 
select fn_table_name

-- variable declaration
create function fn_table_name(integer, integer) returns integer as
$body$
  decalre
    ret integer;
  begin
    ret := $1 + $2;
    return ret;
  end;
$body$
language plpgsql


-- alias in function 
  declare
    x alias for $1;
    y alias for $2;
```

## variable declartion block
```
do
$$
  declare
    my_num    int :=1;    -- default
    f_name    varchar(200) :='adnan';
    l_name    varchar(200);
    id        int = 10;
  begin
    raise noitice 'the values  % % %',
    my_num,
    f_name,
    l_name;
   end;
$$
language plpgsql

-- alias in function 
  declare
    x alias for $1;
    y alias for $2;




-- initializing times
do
$$
  declare
    start_time time := now();
  begin
    raise noitice 'start values  %',start_time:         - fisrt time 
    perform pg_sleep(2)  -- 2 sec
    raise noitice 'next values  %',start_time:          - second time
   end;
$$
language plpgsql


-- copy data from table
  declare
    emp_name employees.first_name%type;    -- %type refers data type of table column or other variable
    y alias for $2;


-- assign var from query
select * from vv into var_name limit 1;
select vv.name into var_name limit 1;

do
$$
  declare
    emp_name employees.first_name%type; 
  begin
      select first_name from employees
      into emp_name
      where p_id = 10
      limit 1;

      raise noitice 'Values  %',emp_name: 
   end;
$$
language plpgsql

-- for full row
do
$$
  declare
    emp employees; 
  begin
      select * from employees
      into emp
      where p_id = 10
      limit 1;

      raise noitice 'Values  %',emp_name.first_name: 
   end;
$$
language plpgsql
```
### in out inout without return
```
create function fn_table_name(in x integer,in y integer,out z integer,out a integer) returns integer as
$body$
  decalre
    ret integer;
  begin
    z := x + y;
    a := x * y;
  end;
$body$
language plpgsql

select fn_table_name(1,2)
```
### block and sub block variable
- use bloc_name.variable_name
```
do
$$
  <<PARENT>>
  decalre
    x integer :=0;
  begin
    x := x + 1;
    raise noitice 'Parent  %',x:
    -- child block
        decalre
          x integer :=0;
        begin
          x := x + 5;
          raise noitice 'child  %',x:
          raise noitice 'Parent  from child %',PARENT.x:
          -- child block
        end parent;
  end PARENT;
$$
language plpgsql
```

### return query result
create or replace function fn_vv returns setof vv as
$$
  begin
    return query 
    seelct * from vv
  end;
$$
language plpgsql;
